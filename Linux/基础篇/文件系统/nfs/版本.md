
# NFS 文件系统版本解析

`NFS`协议到现在经历了`V1`，`V2`,`V3`,`V4`版本，但是它有一个**缺点**就是**协议没有用户认证机制**，而且数据在网络上传送的时候是**明文传送**，所以安全性极差，**一般只能在局域网中使用**。

`NFSv4`是**1995**年发布的，相比`NFSv3`，`NFSv4`发生了比较大的变化，最大的变化是`NFSv4` **有状态了**。`NFSv2`和`NFSv3`都是**无状态协议**，服务区端不需要维护客户端的状态信息。

无状态协议的一个**优点**在于**灾难恢复**，当服务器出现问题后，客户端只需要重复发送失败请求就可以了，直到收到服务器的响应信息。但是某些操作必须需要状态，如**文件锁**。如果客户端申请了文件锁，但是服务器重启了，由于`NFSv3`无状态，客户端再执行锁操作可能就会出错了。`NFSv3`需要`NLM`协助才能实现文件锁功能，但是有的时候两者配合不够协调。

`NFSv4`设计成了一种有状态的协议，自身实现了文件锁功能，就不需要`NLM`协议了。


`NFSv4`和`NFSv3`的**差别**如下：

1. `NFSv4`设计成了一种有状态的协议，自身实现了文件锁功能和获取文件系统根节点功能，不需要`NLM`和`MOUNT`协议协助了。

2. `NFSv4`增加了安全性，支持`RPCSEC-GSS`身份认证。

3. `NFSv4`只提供了两个请求`NULL`和`COMPOUND`，所有的操作都整合进了`COMPOUND`中，客户端可以根据实际请求将多个操作封装到一个`COMPOUND`请求中，增加了灵活性。

4. `NFSv4`文件系统的命令空间发生了变化，服务器端**必须**设置一个根文件系统(`fsid=0`)，其他文件系统挂载在根文件系统上导出。

5. `NFSv4`支持`delegation`。
   
   由于多个客户端可以挂载同一个文件系统，为了保持文件同步，`NFSv3`中客户端需要经常向服务器发起请求，请求文件属性信息，判断其他客户端是否修改了文件。如果文件系统是只读的，或者客户端对文件的修改不频繁，频繁向服务器请求文件属性信息会降低系统性能。`NFSv4`可以依靠`delegation`实现文件同步。当**客户端A**打开一个文件时，服务器会分配给**客户端A**一个`delegation`。只要**客户端A**具有`delegation`，就可以认为与服务器保持了一致。如果另外一个**客户端B**访问同一个文件，则服务器会暂缓**客户端B**的访问请求，向**客户端A**发送`RECALL`请求。当**客户端A**接收到`RECALL`请求时将本地缓存刷新到服务器中，然后将`delegation`返回服务器，这时服务器开始处理**客户端B**的请求。

6. `NFSv4`修改了文件属性的表示方法。
   
   由于`NFS`是`Sun`开发的一套文件系统，设计之出`NFS`文件属性参考了`UNIX`中的文件属性，可能`Windows`中不具备某些属性，因此`NFS`对操作系统的兼容性不太好。`NFSv4`将文件属性划分成了**三类**：
        
    `Mandatory Attributes`: 这是文件的**基本属性**，所有的操作系统必须支持这些属性。
        
    `Recommended Attributes`: 这是`NFS` **建议的属性**，如果可能操作系统尽量实现这些属性。
        
    `Named Attributes`: 这是操作系统可以自己实现的一些文件属性。

7. 服务器端拷贝
   
   如果客户需要从一个`NFS`服务器拷贝数据到另外一个`NFS`服务器,`nfsv4`可以让两台`NFS`服务器之间**直接拷贝数据**，不需要经过客户端。

8. 资源预留和回收

    `NFSv4`为**虚拟分配**提供的新特性。随着存储虚拟分配功能的普及使用，`nfsv4`可以为预留固定大小的存储空间;同样在文件系统上删除文件后，也能够在存储上面释放相应空间。

9.  国际化支持

    `NFSv4`文件名、目录、链接、用户与组可以使用 `UTF-8字符集`，`UTF-8` **兼容** `ASCII码`，使得`NFSv4`支持更多语言。

10. `RPC`合并调用

    `NFSv4`允许将多个请求合并为一个`rpc`引用，在`NFSv3`每个请求对应一个`rpc`调用。`WAN`环境中，`NFSv4`合并`rpc`调用可以**显著降低延迟**。

11. 安全性：

    `NFSv4`用户验证采用**“用户名+域名”**的模式，与`Windows`  `AD`验证方式类似，`NFSv4`强制使用`Kerberos`验证方式。(`Kerberos`与`Windows  AD`都遵循相同`RFC1510标准`)，这样方便`windows`和`*nix`环境混合部署。

12. `pNFS`

    **并行NFS文件系统**，元数据服务器负责用户请求调度、数据服务器负责客户请求处理。`pNFS`需要`NFS`服务器和客户端协同支持

后来的 `NFSv4.1`，与`NFSv4.0`相比，`NFSv4.1`最大的变化是**支持并行存储**了。

在以前的协议中，客户端直接与服务器连接，客户端直接将数据传输到服务器中。

当客户端数量较少时这种方式没有问题，但是如果大量的客户端要访问数据时，`NFS`服务器很快就会成为一个瓶颈，抑制了系统的性能。

`NFSv4.1`支持并行存储，服务器由一台 **元数据服务器(MDS)** 和多台 **数据服务器(DS)** 构成，元数据服务器只管理文件在磁盘中的布局，数据传输在客户端和数据服务器之间直接进行。由于系统中包含多台数据服务器，因此数据可以以并行方式访问，系统吞吐量迅速提升。

现在新的是`nfsv4.2`, 所以尽可能用`nfs4`


