# `NodeJS` 导出 `Excel`

## 需求场景

这个场景实在是太多了，很多项目都会遇到数据导出的需求，并且大部分数据导出的需求都是导出 `Excel` 。

导出可以是前端来做（例如浏览器等），也可以是后端来做，各有利弊。

## 方案评估

在数据量上来的情况下，前端来做导出已经很不合适了（因为性能、资源和功能等原因）。

本人亲测： `1000` 条数据导出需要 `10秒` ， `2000` 条数据需要 `1分钟` ，用的是[xlsx](https://www.npmjs.com/package/xlsx)这个包，浏览器为 `Chrome` 。

## 解决方案

在大量数据场景下，每个 `Excel` 需要导出上万条甚至上百万条的时候，前端来导出就显得捉襟见肘了（ `PS：` 我一直在找前端 `Stream` 写入文件的方法，但是没有找到，如果有的话，能够极大的提升前端导出 `Excel` 的上限）。 `node` 后台来做也需要一些特殊的处理，不应该一下将上万条数据全部取出扔到内存中！

一般通过数据库的**流**来实现。本地开一个文件流，数据库中的数据流出来后经过加工处理后流式写入到文件中。这样内存就省下了很多开销。

## 存在问题

原版 `Excel` 是不能流式写入数据的，他是**特殊格式**。我们实际上是写入了 `csv` 格式，只不过把扩展名更改成了 `xlsx` 或 `xls` 来用 `Excl` 打开 `cvs` 文件。

这里面就有问题了，如果使用的是低版本的 `Microsoft Office` ，例如： `Office 2010` ，打开后就有各种问题。

通常导出文件是 `utf-8` 格式的，这个格式不加处理，那么通过 `Office 2010` 打开就会呈现乱码。为了解决乱码，需要导出 `utf-8 BOM` 格式的文件。

但是还有问题，那就是 `\t` 制表符的作用没了！这个问题的原因是因为低版本 `Office` 对于 `csv` 文件的显示问题。它先判断文件的编码类型，如果是 `utf-8` 格式的，那么会用 `逗号（, ）` 来作为分隔符，如果是 `unicode` 格式的，那么会用制表符 `\t` 来作为分隔符。因此我们在导出的时候需要用逗号来替换制表符 `\t` ，这样就OK了。但是数据中如果也有逗号，那就会陷入另一个坑！
