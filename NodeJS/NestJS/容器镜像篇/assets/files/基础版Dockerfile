FROM node:14.15.0-alpine

LABEL maintainer="Iric<iricbing@gmail.com>"

WORKDIR /app

COPY . .

RUN yarn install --prod --ignore-scripts

EXPOSE 3000

# 基础配置
ENV COMMON_JWT_EXPIRES_IN=7200000
ENV COMMON_PRINT_USER_ACTIVITY_LOG=false
ENV COMMON_PRINT_SYSTEM_LOG=false
ENV COMMON_ENABLE_SWAGGER=false
ENV COMMON_PASSWORD_SALT=AxJK4m+APM1QcU1eRzFdZ7
ENV COMMON_PORT=3000

# 微服务相关
ENV MICRO_GRPC_BIND=0.0.0.0
ENV MICRO_GRPC_PORT=3300
ENV MICRO_LOG_HOST=kunda-log
ENV MICRO_LOG_PORT=3000

# 数据库相关
ENV DATABASE_TYPE=postgres
ENV DATABASE_HOST=kunda-postgresql
ENV DATABASE_PORT=5432
ENV DATABASE_USERNAME=postgres
ENV DATABASE_PASSWORD=p5tgb6tfc%^
ENV DATABASE_DATABASE=kunda
ENV DATABASE_SYNCHRONIZE=true
ENV DATABASE_LOGGING=false

# 用作token验证的redis数据库
ENV REDIS_TOKEN_NAME=token
ENV REDIS_TOKEN_DB=2
ENV REDIS_TOKEN_HOST=kunda-redis
ENV REDIS_TOKEN_PORT=6379
ENV REDIS_TOKEN_PASSWORD=
ENV REDIS_TOKEN_KEY_PREFIX=kunda-token-

# 用作分布式锁的redis数据库
ENV REDIS_LOCK_NAME=lock
ENV REDIS_LOCK_DB=3
ENV REDIS_LOCK_HOST=kunda-redis
ENV REDIS_LOCK_PORT=6379
ENV REDIS_LOCK_PASSWORD=
ENV REDIS_LOCK_KEY_PREFIX=kunda-lock-

ENV KAFKA_BROKER_LIST=[\"kunda-kafka:9092\"]

CMD ["node" ,"dist/main.js"]

