# MongoDB 模式设计最佳实践

**MongoDB是无模式的，开发人员必须设计集合和索引以适应这一事实。**

## 早期和常见索引

使用MMS、Compass GUI或早期的日志和索引识别常见查询模式，并在项目开始时使用尽可能多的索引。

## 消除不必要的索引

这与上面的设计感觉好像是一点自相矛盾的味道，其实不然，它指的是 **监控数据库以更改查询模式并删除未使用的索引**。索引将消费RAM和I/O，因为它需要与数据库中的文档一起存储和更新。使用 `聚合管道` 和 `$ indexStats` ，开发人员可以识别很少用的索引并消灭他们。

## 使用复合索引而不是索引交集

使用多个谓词（例如 A and B, C or D and E 等）查询， `大多数情况下使用单个复合索引比使用多个简单索引效果要好` 。此外， `复合索引将按字段排序其数据，开发人员可以在查询时使用此优势` 。字段 A、B、C的索引将用于查询A、（A，B）、（A，B，C），但不用于查询（B，C）或（C）。

## 低选择性索引

例如：对性别字段建立索引时，将在统计上仍然返回一般的文档，而如果对姓氏字段建立索引，则将只返回少数具备相同姓氏的文档。

## 使用正则表达式

由于索引按值排序，因此使用带有**前导通配符**（即 `/.*BASE/` ）的正则表达式进行搜索将无法使用索引。只要表达式中有足够区分特征的字符，使用**尾随通配符**（即： `/DATA.*/` ）进行搜索就会很有效。

## 避免在查询中使用否定

**索引是索引值，而不是缺少索引值。**因此，在查询中使用 `NOT` 可能会导致全表扫描而不是使用索引。

## 使用部分索引

如果开发人员需要索引集合中文档的**子集**，则**部分索引可以帮助实现最小化索引集并提高性能**。部分索引将包括开发人员在所需查询中使用的过滤器上的条件。

## 使用文档验证

MongoDB提供了在插入和更新时验证文档的功能。**每个集合都是基于使用validator选项来指定验证规则的**。该validator选项是给文档指定验证规则或表达式。使用文档验证功能可以监控插入文档中的新属性，并决定如何处理他们。

## 使用MongoDB Compass

这个是MongoDB的免费可视化工具，它非常适合快速浏览数据及观察它如何随时间增长。

## 最大文档为16M

**MongoDB的最大文档大小为16M**。这是一个相当宽松的限制，但在任何情况下都不应该违反。允许文档无限制的增长不应该是一种选择，开发人员应该尽可能高效率的嵌入文档，并始终牢记这些控制。

## 使用适当的存储引擎

MongoDB从3.2版本开始引入几个新的存储引擎。 `InMemory存储引擎` 应该用于**实时工作负载**，而 `加密存储引擎` 应该是**对数据安全性有严格要求时**的首选引擎。
