# Zookeeper 简介

参考资料 [ZooKeeper简介（浅入）](https://juejin.im/post/6844903684610981895)

必读：[漫画：什么是Zookeeper](https://juejin.im/post/6844903684610981895) (PS: 漫画作者真的很用心，必须点赞)

## 背景

Zookeeper是为了解决分布式问题的，首先看一下分布式系统简化图

![分布式系统简略图](assets/images/分布式系统简略图.jpg)

上图中有三台机器，每台机器跑同样的一个应用程序。然后我们将这三台机器通过网络将其连接起来，构成一个系统来为用户提供服务，对用户来说这个系统的架构是透明的，他感觉不到这个系统是一个什么样的架构。那么我们就可以把这种系统称作一个 `分布式系统` 。

问题来了：

1. 程序的运行往往依赖很多配置文件，比如数据库地址、黑名单控制、服务地址列表等，而且有些配置信息需要频繁地进行动态变更，这时候怎么保证所有机器共享的配置信息保持一致？
2. 如果有一台机器挂掉了，其他机器如何感知到这一变化并接管任务？如果用户激增，需要增加机器来缓解压力，如何做到不重启集群而完成机器的添加？
3. 用户数量增加或者减少，会出现有的机器资源使用率繁忙，有的却空闲，如何让每台机器感知到其他机器的负载状态从而实现负载均衡？
4. 在一台机器上要多个进程或者多个线程操作同一资源比较简单，因为可以有大量的状态信息或者日志信息提供保证，比如两个A和B进程同时写一个文件，加锁就可以实现。但是分布式系统怎么办？需要一个三方的分配锁的机制，几百台worker都对同一个网络中的文件写操作，怎么协同？还有怎么保证高效的运行？

## ZooKeeper的前世今生

分布式系统的很多难题，都是由于 `缺少协调机制` 造成的。

目前，在分布式协调技术方面做得比较好的就是Google的Chubby还有Apache的ZooKeeper。有人会问既然有了Chubby为什么还要弄一个ZooKeeper，难道Chubby做得不够好吗？主要是Chubby是非开源的，Google自家用。后来雅虎模仿Chubby开发出了ZooKeeper，也实现了类似的 `分布式锁` 的功能，并且将ZooKeeper作为一种开源的程序捐献给了Apache，那么这样就可以使用ZooKeeper所提供锁服务。

## 什么是Zookeeper

Zookeeper是一个 `分布式协调服务` (a service for coordinating processes of distributed applications)。此句理解的重点是 `协调` 二字。协调就是协调资源，避免因资源竞争导致的bug（思维引导：如果感觉此处比较抽象，不好理解，可以顺带看一下[数据库事物](../../../数据库/SQL/事物.md)）。可能看到资源资源竞争这里，第一反应就是 `锁` ，对，没错，就是 `锁` ！基本上每个语言都有自己的一套锁机制， `synchronized` 这个关键字对于Java和C#的开发者应该不陌生，在此不做赘述。

可能你会想到，那我将Java那套锁机制搬到分布式系统中，将线程比作不同的分布式节点，那不就完了嘛？

是的，表面上是可以这么说。但分布式系统中， `说往往比做容易得多!` 。(PS: 不止分布式系统中，那里都是)

`原则:` 在分布式系统中，所有同一个进程内的任何假设都不存在：因为 `网络是不可靠的` !!!

## Zookeeper可以干什么

在Zookeeper的官网上有这么一句话： `ZooKeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and providing group services.`
这大概描述了Zookeeper主要可以干哪些事情： `配置管理` 、 `名字服务` 、 `分布式同步` 以及 `集群管理` 。

### 配置管理

在我们的应用中除了代码外，还有一些就是各种配置。比如数据库连接等。一般我们都是使用配置文件的方式，在代码中引入这些配置文件。当我们只有一种配置、一台服务器，并且不经常修改的时候，使用配置文件是一个很好的做法，但是如果我们配置非常多，有很多服务器都需要这个配置，而且还可能是动态的话使用配置文件就不是个好主意了。这个时候往往需要寻找一种集中管理配置的方法，我们在这个集中的地方修改了配置，所有对这个配置感兴趣的都可以获得变更。

比如把这公用的配置文件提取出来放到一个地方，对这个地方（目录节点）进行监听，一旦配置信息发生变化，每个应用程序就会收到Zookeeper的通知，然后从Zookeeper获取新的配置信息应用到系统中。但是，因为很多服务的正常运行都非常依赖这个配置，所以需要这个集中提供配置服务的服务具备很高的可靠性。一般我们可以用一个集群来提供这个配置服务，但是用集群提升可靠性，那如何保证配置在集群中的一致性呢？

这个时候就需要使用一种实现了一致性协议的服务了。Zookeeper就是这种服务，它使用 `Zab这种一致性协议` 来提供一致性。现在有很多开源项目使用Zookeeper来维护配置，比如，在开源的消息队列Kafka中，也使用Zookeeper来维护broker的信息；在Alibaba开源的SOA框架Dubbo中也广泛的使用Zookeeper管理一些配置来实现服务治理；在HBase中，客户端就是连接一个Zookeeper，获得必要的HBase集群的配置信息，然后才可以进一步操作。

### 命名服务

命名服务这个就很好理解了。比如为了通过网络访问一个系统，我们得知道对方的IP地址，但是IP地址对人非常不友好，这个时候我们就需要使用域名来访问。但是计算机是不能识别域名的。怎么办呢？如果我们每台机器里都有一份域名到IP地址的映射，这个倒是能解决一部分问题，但是如果域名对应的IP发生变化了又该怎么办呢？

于是我们有了DNS这个东西。我们只需要访问一个大家熟知的(known)的点，它就会告诉你这个域名对应的IP是什么。在我们的应用中也会存在很多这类问题，特别是在我们的服务特别多的时候，如果我们在本地保存服务的地址将非常不方便，但是如果我们只需要访问一个大家都熟知的访问点，这里提供统一的入口，那么维护起来将方便多了。

比如，用过Duboo+Zookeeper整合的系统的人也能知道，正是因为这个命名服务，才方便了分布式中各个项目之间的联系. 在SOA(Service-Oriented Architecture)框架里面，RMI(Remote Method Invoke)框架就是通过某个服务器上的URL来获取远程服务器上的对象来调用服务，但到集群和分布式环境下，如何做到子项目之间调用的关系不会很复杂，不会到时候出现问题都不知道哪个服务调用的哪个，所以这里就需要一个服务器专门替我们管理这些服务，这样我们就可以集中精力在业务处理上。Zookeeper的命名功能就是这么一个服务器。在集群中，相同的一个服务有很多个提供者，这些提供者启动时，提供者的相关信息（服务接口，地址，端口等）注册到Zookeeper中，当消费者要消费某服务的时候，从Zookeeper中获取该服务的所有提供者的信息目录，再根据Dubbo的负载均衡机制选择一个提供者.

 `其实从配置管理、命名服务的作用中可以看出，Zookeeper相当于一个文件系统（类似与linux文件系统），换句话说，zookeeper是分布式中的大脑。`

### 分布式锁

分布式锁，又叫 `分布式的同步` 。比如，上文中提到了Zookeeper是一个分布式协调服务，这样我们就可以利用Zookeeper来协调多个分布式进程之间的活动。

比如在一个分布式环境里，为了提高可靠性，我们的集群中每台服务器上都部署着同样的服务。但是，一件事情如果集群中的每个服务器都进行的话，那相互之间就要协调，编程起来将非常复杂。而如果我们只让一个服务进行操作，那又存在单点。通常还有一种做法就是使用分布式锁，在某个时刻只让一个服务去干活，当这台服务出问题的时候锁释放，立即fail over到另外的服务。

很多分布式系统都是这么做的，这种设计有一个更好听的名字叫 `Leader Election(leader选举)` 。比如HBase的Master就是采用这种机制。

但要注意的是分布式锁跟同一个进程的锁还是有区别的，所以使用的时候要比同一个进程里的锁更谨慎的使用。

### 集群管理

在分布式的集群中，经常会由于各种原因，比如硬件故障，软件故障，网络问题，有些节点会进进出出。有新的节点加入进来，也有老的节点退出集群。这个时候，集群中其他机器需要感知到这种变化，然后根据这种变化做出对应的决策。

比如在一个分布式存储系统中，有一个中央控制节点负责存储的分配，当有新的存储进来的时候我们要根据现在集群目前的状态来分配存储节点。这个时候我们就需要动态感知到集群目前的状态。

还有，比如一个分布式的SOA架构中，服务是一个集群提供的，当消费者访问某个服务时，就需要采用某种机制发现 现在有哪些节点可以提供该服务(这也称之为服务发现，比如Alibaba开源的SOA框架Dubbo，就采用了Zookeeper作为服务发现的底层机制)。还有开源的Kafka队列就采用了Zookeeper作为Cosnumer的上下线管理。
